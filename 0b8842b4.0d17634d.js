(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{102:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return l})),n.d(t,"rightToc",(function(){return c})),n.d(t,"default",(function(){return s}));var a=n(2),r=(n(0),n(137));const o={id:"get-it-to-kubernetes-right",title:"Get It To Kubernetes Right",sidebar_label:"Get It To Kubernetes Right"},l={id:"get-it-to-kubernetes-right",isDocsHomePage:!1,title:"Get It To Kubernetes Right",description:"You should already have the repo cloned from the setup step.",source:"@site/docs/get-it-to-kubernetes-right.md",permalink:"/app-to-k8s/docs/get-it-to-kubernetes-right",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/get-it-to-kubernetes-right.md",sidebar_label:"Get It To Kubernetes Right",sidebar:"docs",previous:{title:"Get It To Kubernetes",permalink:"/app-to-k8s/docs/get-it-to-kubernetes"},next:{title:"Kubernetes Best Practices",permalink:"/app-to-k8s/docs/kubernetes-best-practices"}},c=[{value:"Check the App",id:"check-the-app",children:[]},{value:"Rolling our OWN",id:"rolling-our-own",children:[]}],i={rightToc:c};function s({components:e,...t}){return Object(r.b)("wrapper",Object(a.a)({},i,t,{components:e,mdxType:"MDXLayout"}),Object(r.b)("p",null,"You should already have the repo cloned from the setup step."),Object(r.b)("p",null,"Incase you dont"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"git clone https://github.com/moficodes/app-to-k8s.git\n")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"cd app-to-k8s/k8s/all-deployment-svc/\n")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"kubectl apply -f .\n")),Object(r.b)("p",null,"Go back to the root of the folder."),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"cd ../..\n")),Object(r.b)("p",null,"You should an output like"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"service/factorial-service created\ndeployment.apps/fact-deploy created\nservice/fib-service created\ndeployment.apps/fib-deploy created\nservice/prime-service created\ndeployment.apps/prime-deploy created\nservice/ui-service created\ndeployment.apps/foxfram-ui created\n")),Object(r.b)("p",null,"Whoa! alot of thing happened pretty fast. "),Object(r.b)("p",null,"Lets take a step back a look at each of the parts individually."),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),'cat foxfram-fib-v1-deployment.yaml\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name:  fib-deploy\n  namespace: default\n  labels:\n    app: fib\n    version: v1\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: fib\n  strategy:\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 1\n    type: RollingUpdate\n  template:\n    metadata:\n      labels:\n        app: fib\n        version: v1\n    spec:\n      containers:\n      - image:  moficodes/foxfram-fib:0.0.5\n        name:  fib\n        imagePullPolicy: Always\n        resources:\n          requests:\n            cpu: "250m"\n            memory: "128Mi"\n          limits:\n            cpu: "250m"\n            memory: "128Mi"\n        livenessProbe:\n          httpGet:\n            path: /health\n            port: 8080\n          initialDelaySeconds: 3\n          periodSeconds: 3\n        ports:\n        - containerPort:  8080\n          name: http\n      restartPolicy: Always\n')),Object(r.b)("p",null,"This looks way longer than what we saw initially. Why is that?"),Object(r.b)("p",null,"First We have some labels. Labels are kubernetes way of uniquely identifying components. You can put labels of anything. In our case we put labels of the app and and version. ","(","App and version are not key words",")"),Object(r.b)("p",null,"In the template for our container wen can see we have the image name. The image is hosted in ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://cloud.docker.com/u/moficodes/repository/list"}),"docker hub"),". "),Object(r.b)("p",null,Object(r.b)("strong",{parentName:"p"},"Update Strategy")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"...\n  strategy:\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 1\n    type: RollingUpdate\n...\n")),Object(r.b)("p",null,"This block manages how our app updates. We have chose rolling update. Means the app will update incrementally. ",Object(r.b)("inlineCode",{parentName:"p"},"maxSurge")," defines how many extra pods we can spawn. ",Object(r.b)("inlineCode",{parentName:"p"},"maxUnavailable")," defines how many pods we are allowed to have less than spec."),Object(r.b)("p",null,"So if our replica count is 3 during an update we may have 2-4 pods available with the current settings. For a crucial service you may want to have a higher ",Object(r.b)("inlineCode",{parentName:"p"},"maxSurge")," and a lower ",Object(r.b)("inlineCode",{parentName:"p"},"maxUnavailable")," count."),Object(r.b)("p",null,Object(r.b)("strong",{parentName:"p"},"Resource Quota")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),'...\n        resources:\n          requests:\n            cpu: "250m"\n            memory: "128Mi"\n          limits:\n            cpu: "250m"\n            memory: "128Mi"\n...\n')),Object(r.b)("p",null,"This part is interesting and a great feature in kubernetes. We can set pod level resource constrains so one service does not end up starving others. This kind of constraints can be setup for namespaces as well. This is great for isolating userspace and managing resource per team or per service."),Object(r.b)("p",null,Object(r.b)("strong",{parentName:"p"},"Liveness Probe")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"...\n        livenessProbe:\n          httpGet:\n            path: /health\n            port: 8080\n          initialDelaySeconds: 3\n          periodSeconds: 3\n...\n")),Object(r.b)("p",null,"Next we have something called a liveness probe. There is another probe called readiness probe. So liveness probe and readiness probe can look for some sign that the pod is alive or ready to serve request. In my app I setup a http liveness probe, k8s apiserver is making a http get request to the /health endpoint once every 3 second. In my app I have a random number generator and once about every 10 checks the health check fails and the app restart. "),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"kubectl get po\n\nNAME                           READY   STATUS    RESTARTS   AGE\nfact-deploy-576cd9b5c4-jhqd6   1/1     Running   2          39m\nfact-deploy-576cd9b5c4-lzzpk   1/1     Running   0          39m\nfact-deploy-576cd9b5c4-xmfg7   1/1     Running   1          39m\n")),Object(r.b)("p",null,"The restart happens randomly."),Object(r.b)("p",null,"You can define liveness and readiness probes to be "),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"A Command"),Object(r.b)("li",{parentName:"ul"},"Http Request"),Object(r.b)("li",{parentName:"ul"},"TCP Probe")),Object(r.b)("p",null,"Liveness and Readiness probes are super useful when you are waiting for some process to start before you start serving request or if a crucial component of your app goes away."),Object(r.b)("h2",{id:"check-the-app"},"Check the App"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"kubectl get svc\n\nNAME                TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE\nfactorial-service   ClusterIP      172.21.140.45    <none>        80/TCP         68m\nfib-service         ClusterIP      172.21.24.38     <none>        80/TCP         68m\nkubernetes          ClusterIP      172.21.0.1       <none>        443/TCP        6d10h\nprime-service       ClusterIP      172.21.164.123   <none>        80/TCP         68m\nui-service          LoadBalancer   172.21.80.239    xxx.xx.xx.x   80:32103/TCP   68m\n")),Object(r.b)("p",null,"You should see a external ip for the UI service. From your browser go to that url."),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},"Don't use your phone or Safari browser. The UI for some reason does not look right there. Will fix this in a future version.")),Object(r.b)("h2",{id:"rolling-our-own"},"Rolling our OWN"),Object(r.b)("p",null,"We used the image I made and made public via docker hub. While it is easy, it is neither safe nor the best practice."),Object(r.b)("p",null,"Let's see how we can build our images and store it in a private registry."),Object(r.b)("p",null,"I created a namespace ",Object(r.b)("inlineCode",{parentName:"p"},"mofi-workshop")," We will all build our images and push there. To avoid naming collision,"),Object(r.b)("p",null,"Use the following format"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"mofi-workshop/<Number of Your cluster>-<service-name>:<Tag>\n")),Object(r.b)("p",null,"For example I have the cluster ",Object(r.b)("inlineCode",{parentName:"p"},"app-to-k8s-workshop01")," "),Object(r.b)("p",null,"So for fib service my image name becomes"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"mofi-workshop/01-fib:0.0.1\n")),Object(r.b)("p",null,"Run the following."),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"ibmcloud cr login\n")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"Logging in to 'registry.ng.bluemix.net'...\nLogged in to 'registry.ng.bluemix.net'.\n\nIBM Cloud Container Registry is adopting new icr.io domain names to align with the rebranding of IBM Cloud for a better user experience. The existing bluemix.net domain names are deprecated, but you can continue to use them for the time being, as an unsupported date will be announced later.\xa0For more information about registry domain names, see https://cloud.ibm.com/docs/services/Registry?topic=registry-registry_overview#registry_regions_local\n\nLogging in to 'us.icr.io'...\nLogged in to 'us.icr.io'.\n\nIBM Cloud Container Registry is adopting new icr.io domain names to align with the rebranding of IBM Cloud for a better user experience. The existing bluemix.net domain names are deprecated, but you can continue to use them for the time being, as an unsupported date will be announced later.\xa0For more information about registry domain names, see https://cloud.ibm.com/docs/services/Registry?topic=registry-registry_overview#registry_regions_local\n\nOK\n")),Object(r.b)("p",null,"From the root of the folder you need to go into each of the src folders."),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"cd src/foxfram-fib\nibmcloud cr build mofi-workshop/<number>-fib:0.0.1 .\n")),Object(r.b)("p",null,Object(r.b)("inlineCode",{parentName:"p"},"ibmcloud cr build")," command builds and pushes the image into the ",Object(r.b)("inlineCode",{parentName:"p"},"mofi-workshop")," namespace. "),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"cd ../foxfram-prime\nibmcloud cr build mofi-workshop/<number>-prime:0.0.1 .\n")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"cd ../foxfram-factorial\nibmcloud cr build mofi-workshop/<number>-factorial:0.0.1 .\n")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"cd ../foxfram-ui\nibmcloud cr build mofi-workshop/<number>-ui:0.0.1 .\n")),Object(r.b)("p",null,"Once all the images have been built without any error. We can then go take a look if they are actually there."),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"ibmcloud cr images | grep mofi-workshop/<number>\n")),Object(r.b)("p",null,"Once you have all 4 images created, time  to update our deployments."),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"cd k8s/all-deployment-svc\n")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"nano foxfram-fib-v1-deployment.yaml\n")),Object(r.b)("p",null,"change the following"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"from\n- image:  moficodes/foxfram-fib:0.0.5\nto\n- image:  us.icr.io/mofi-workshop/01-fib:0.0.1\n")),Object(r.b)("p",null,"Do similar changes for  "),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"foxfram-fact-v1-deployment.yaml\nfoxfram-prime-v1-deployment.yaml\nfoxfram-ui-v1-deployment.yaml\n")),Object(r.b)("p",null,"once all the files are updated with the new images."),Object(r.b)("p",null,"Run"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"kubectl apply -f .\n")),Object(r.b)("p",null,"If everything goes well our app should be up and running."))}s.isMDXComponent=!0},137:function(e,t,n){"use strict";n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return d}));var a=n(0),r=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=r.a.createContext({}),p=function(e){var t=r.a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):c(c({},t),e)),n},b=function(e){var t=p(e.components);return r.a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},m=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,s=i(e,["components","mdxType","originalType","parentName"]),b=p(n),m=a,d=b["".concat(l,".").concat(m)]||b[m]||u[m]||o;return n?r.a.createElement(d,c(c({ref:t},s),{},{components:n})):r.a.createElement(d,c({ref:t},s))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,l=new Array(o);l[0]=m;var c={};for(var i in t)hasOwnProperty.call(t,i)&&(c[i]=t[i]);c.originalType=e,c.mdxType="string"==typeof e?e:a,l[1]=c;for(var s=2;s<o;s++)l[s]=n[s];return r.a.createElement.apply(null,l)}return r.a.createElement.apply(null,n)}m.displayName="MDXCreateElement"}}]);